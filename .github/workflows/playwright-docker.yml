name: Playwright Tests with Docker

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t spacex-playwright-tests .

      - name: Run tests and debug Allure setup
        run: |
          # First, check what reporters are available
          echo "=== Checking Playwright reporters ==="
          docker run --rm spacex-playwright-tests npx playwright test --list

          echo "=== Running tests with Allure debug ==="
          docker run --rm \
            -e UI_BASE_URL=https://www.spacex.com \
            -e API_BASE_URL=https://api.spacexdata.com/v4 \
            -v $(pwd)/allure-results:/app/allure-results \
            -w /app \
            spacex-playwright-tests

      - name: Check Allure results thoroughly
        run: |
          echo "=== Comprehensive file search ==="
          echo "Allure results directory:"
          ls -la allure-results/ || echo "No allure-results directory"

          echo "=== Searching for any test result files ==="
          find . -name "*.json" -not -path "./node_modules/*" | head -20 || echo "No JSON files found"
          find . -name "allure-results" -type d | head -5
          find . -name "*result*" -type f | head -10

      - name: Upload Allure results (if any)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: allure-results/
          retention-days: 30

  debug-reporter:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Debug reporter installation
        run: |
          echo "=== Checking package.json for allure-playwright ==="
          npm list allure-playwright || echo "allure-playwright not found"

          echo "=== Available Playwright reporters ==="
          npx playwright test --help | grep -A 20 "reporter" || echo "Could not get reporter list"

  alternative-approach:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright and Allure
        run: |
          npx playwright install --with-deps
          npm install allure-playwright@^2.13.0

      - name: Generate BDD tests
        run: npx bddgen

      - name: Run tests with Allure reporter (direct approach)
        run: |
          npx playwright test --reporter=list,allure-playwright
          echo "=== Checking for Allure results ==="
          ls -la allure-results/ || echo "No allure-results directory"
          find allure-results -name "*.json" | head -5

      - name: Upload results from direct approach
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: direct-allure-results
          path: allure-results/
          retention-days: 30

  report:
    runs-on: ubuntu-latest
    needs: [test-docker, alternative-approach]
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download and combine Allure results
        run: |
          mkdir -p combined-allure-results

          # Try to get results from docker approach
          if [ -d "allure-results" ]; then
            cp -r allure-results/* combined-allure-results/ 2>/dev/null || echo "No files in docker results"
          fi

          # Try to get results from direct approach
          if [ -d "direct-allure-results" ]; then
            cp -r direct-allure-results/* combined-allure-results/ 2>/dev/null || echo "No files in direct results"
          fi

          echo "=== Combined results ==="
          ls -la combined-allure-results/
          find combined-allure-results -name "*.json" | wc -l

      - name: Setup Java and Allure
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "11"
        if: always()

      - name: Install Allure CLI
        run: |
          wget -q https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -xzf allure-2.27.0.tgz
          sudo ln -s $(pwd)/allure-2.27.0/bin/allure /usr/local/bin/allure
        if: always()

      - name: Generate Allure report
        run: |
          echo "=== Generating report from combined results ==="
          allure generate combined-allure-results --clean -o allure-report
          echo "=== Report contents ==="
          ls -la allure-report/
        if: always()

      - name: Upload Allure report
        uses: actions/upload-pages-artifact@v3
        if: always()
        with:
          path: allure-report/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: report
    if: always()

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
