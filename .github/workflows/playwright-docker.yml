name: Playwright Tests with Docker

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

jobs:
  test-docker:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker image
        run: |
          docker build -t spacex-playwright-tests .

      - name: Run tests in Docker with debug output
        run: |
          docker run --rm \
            -e UI_BASE_URL=https://www.spacex.com \
            -e API_BASE_URL=https://api.spacexdata.com/v4 \
            -e DEBUG=pw:api \
            -v $(pwd)/allure-results:/app/allure-results \
            -w /app \
            spacex-playwright-tests

      - name: Debug Allure results structure
        run: |
          echo "=== Allure results directory ==="
          ls -la allure-results/ || echo "No allure results directory"

          echo "=== Allure results file details ==="
          find allure-results/ -name "*.json" -exec echo "File: {}" \; -exec head -5 {} \; -exec echo "---" \; || echo "No JSON files found"

          echo "=== File counts ==="
          echo "JSON files: $(find allure-results/ -name "*.json" | wc -l)"
          echo "TXT files: $(find allure-results/ -name "*.txt" | wc -l)"
          echo "XML files: $(find allure-results/ -name "*.xml" | wc -l)"

      - name: Upload Allure results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: allure-results
          path: allure-results/
          retention-days: 30

      - name: Upload test results for debugging
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-debug-files
          path: |
            test-results.json
            cucumber-report/
          retention-days: 30

  diagnose-results:
    runs-on: ubuntu-latest
    needs: test-docker
    if: always()

    steps:
      - name: Download Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: diagnose-allure-results

      - name: Analyze Allure result files
        run: |
          echo "=== Detailed file analysis ==="
          for file in diagnose-allure-results/*.json; do
            if [ -f "$file" ]; then
              echo "üîç Analyzing: $(basename $file)"
              echo "Size: $(wc -c < "$file") bytes"
              echo "First 200 chars:"
              head -c 200 "$file"
              echo -e "\n---"
              # Check if valid JSON
              if jq empty "$file" 2>/dev/null; then
                echo "‚úÖ Valid JSON"
                echo "JSON keys: $(jq -r 'keys | join(", ")' "$file" 2>/dev/null || echo "Cannot parse keys")"
              else
                echo "‚ùå INVALID JSON - This is likely the problem!"
                echo "Raw content:"
                cat "$file"
              fi
              echo "=========="
            fi
          done

  report:
    runs-on: ubuntu-latest
    needs: test-docker
    if: always()

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Allure results
        uses: actions/download-artifact@v4
        with:
          name: allure-results
          path: allure-results

      - name: Verify we have valid results
        run: |
          echo "=== Pre-generation check ==="
          if [ ! -d "allure-results" ]; then
            echo "‚ùå No allure-results directory found"
            exit 1
          fi

          json_count=$(find allure-results -name "*.json" | wc -l)
          echo "JSON files found: $json_count"

          if [ $json_count -eq 0 ]; then
            echo "‚ùå No test result files found"
            echo "Directory contents:"
            ls -la allure-results/
            exit 1
          fi

          # Check first file for validity
          first_file=$(find allure-results -name "*.json" | head -1)
          if jq . "$first_file" >/dev/null 2>&1; then
            echo "‚úÖ First file is valid JSON"
          else
            echo "‚ùå First file is invalid JSON"
            echo "File content:"
            cat "$first_file"
            exit 1
          fi

      - name: Setup Java for Allure
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "11"

      - name: Install Allure
        run: |
          # Install specific version of Allure
          wget -q https://github.com/allure-framework/allure2/releases/download/2.27.0/allure-2.27.0.tgz
          tar -xzf allure-2.27.0.tgz
          sudo ln -s $(pwd)/allure-2.27.0/bin/allure /usr/local/bin/allure
          allure --version

      - name: Generate Allure report
        run: |
          echo "=== Generating Allure report ==="
          allure generate allure-results --clean -o allure-report

          echo "=== Report verification ==="
          if [ -f "allure-report/index.html" ]; then
            size=$(wc -c < allure-report/index.html)
            echo "‚úÖ index.html generated, size: $size bytes"
            if [ $size -lt 1000 ]; then
              echo "‚ö†Ô∏è  Warning: index.html is very small, might be empty"
              head -50 allure-report/index.html
            fi
          else
            echo "‚ùå index.html not generated"
            exit 1
          fi

      - name: Upload Allure report
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report/

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: report
    if: always()

    permissions:
      pages: write
      id-token: write

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
